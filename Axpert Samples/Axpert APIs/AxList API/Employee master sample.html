<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Employee Master</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../../UI/axpertUI/plugins.bundle.css">
    <link rel="stylesheet" href="../../UI/axpertUI/style.bundle.css">
    <link rel="stylesheet" href="../../ThirdParty/jquery-confirm-master/jquery-confirm.min.css">
    <script type="text/javascript" src="../../UI/axpertUI/plugins.bundle.js"></script>
    <script type="text/javascript" src="../../UI/axpertUI/scripts.bundle.js"></script>
    <script type="text/javascript" src="../../Js/noConflict.min.js"></script>
    <script type="text/javascript" src="../../ThirdParty/jquery-confirm-master/jquery-confirm.min.js"></script>
    <script type="text/javascript" src="../../Js/alerts.min.js"></script>
    <script type="text/javascript" src="../../Js/common.min.js?v=13301"></script>
    <script type="text/javascript" src="../../Js/AxInterface.js?v=13301"></script>
    <style>
        th.sortable {
            cursor: pointer;
        }

        th.asc::after {
            content: " ▲";
            font-size: 0.8em;
        }

        th.desc::after {
            content: " ▼";
            font-size: 0.8em;
        }
    </style>
</head>

<body class="p-4 bg-light">

    <div class="">


        <!-- 🔹 Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-3">Employee Master From ADS with user filters, dynamic filters, pagination, sorting</h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Employee Code -->
                    <div class="col-md-4">
                        <label class="form-label">Employee Code (Text filter)</label>
                        <input id="empCodeFilter" type="text" class="form-control" placeholder="Enter code">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Condition (Text filter condition)</label>
                        <select id="empCodeCondition" class="form-select">
                            <option value="CONTAINS">Contains</option>
                            <option value="STARTSWITH">Starts With</option>
                            <option value="ENDSWITH">Ends With</option>
                            <option value="EQUALS">Equals</option>
                        </select>
                    </div>

                    <!-- Salary -->
                    <div class="col-md-3">
                        <label class="form-label">Salary From (Numeric filter)</label>
                        <input id="salaryFrom" type="number" class="form-control" placeholder="Min salary">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Salary To</label>
                        <input id="salaryTo" type="number" class="form-control" placeholder="Max salary">
                    </div>

                    <!-- DOJ -->
                    <div class="col-md-3">
                        <label class="form-label">DOJ From (Date filter. dd/mm/yyyy format)</label>
                        <input id="dojFrom" type="date" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">DOJ To</label>
                        <input id="dojTo" type="date" class="form-control">
                    </div>

                    <!-- Department -->
                    <div class="col-md-3">
                        <label class="form-label">Department (Multiselect filter)</label>
                        <select id="deptFilter" class="form-select" multiple>
                            <option value="HR">HR</option>
                            <option value="Finance">Finance</option>
                            <option value="Sales">Sales</option>
                            <option value="IT">IT</option>
                        </select>
                    </div>

                    <!-- State -->
                    <div class="col-md-3">
                        <label class="form-label">State (User defined filter)</label>
                        <select id="stateFilter" class="form-select">
                            <option value="Karnataka">Karnataka</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Rajasthan">Rajasthan</option>
                        </select>
                    </div>
                </div>

                <div class="mt-3">
                    <button id="applyFilterBtn" class="btn btn-primary">Apply Filters</button>
                    <button id="clearFilterBtn" class="btn btn-secondary">Clear Filters</button>
                    <button id="loadAllRecordsBtn" class="btn btn-secondary">Load All records</button>
                    <button id="refreshBtn" class="btn btn-outline-success">
                        Refresh Cache
                    </button>
                </div>
            </div>
        </div>

        <!-- 🔹 Table -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="employeeTable">
                <thead class="table-dark">
                    <tr>
                        <th class="sortable" data-field="employee_code">Employee Code</th>
                        <th class="sortable" data-field="first_name">Name</th>
                        <th class="sortable" data-field="gender">Gender</th>
                        <th class="sortable" data-field="doj">DOJ</th>
                        <th class="sortable" data-field="department">Department</th>
                        <th class="sortable" data-field="designation">Designation</th>
                        <th class="sortable" data-field="salary">Salary</th>
                        <th class="sortable" data-field="status">Status</th>
                        <th class="sortable" data-field="status">State</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 🔹 Pagination -->
        <div class="mt-3">
            <label for="pageSelect" class="form-label">Page:</label>
            <select id="pageSelect" class="form-select w-auto d-inline-block">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>
        </div>
    </div>

    <!-- 🔹 JavaScript -->
    <script>
        // Global defaults
        let currentPage = 1;
        let pageSize = 10;
        let sorting = [{ fldname: "employee_code", sort_order: "asc" }];
        let filters = [];
        let refreshCache = false;

        function formatDateForAPI(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            const day = String(d.getDate()).padStart(2, "0");
            const month = String(d.getMonth() + 1).padStart(2, "0"); // months are 0-indexed
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Collect filters from inputs
        function collectFilters() {
            filters = [];

            const empCode = document.getElementById("empCodeFilter").value.trim();
            const empCodeCond = document.getElementById("empCodeCondition").value;
            if (empCode) {
                filters.push({
                    fldname: "employee_code",
                    datatype: "TEXT",
                    value: empCode,
                    condition: empCodeCond
                });
            }

            const salaryFrom = document.getElementById("salaryFrom").value;
            const salaryTo = document.getElementById("salaryTo").value;
            if (salaryFrom || salaryTo) {
                filters.push({
                    fldname: "salary",
                    datatype: "NUMERIC",
                    from: salaryFrom || "0",
                    to: salaryTo || "999999999"
                });
            }



            const dojFrom = document.getElementById("dojFrom").value;
            const dojTo = document.getElementById("dojTo").value;

            if (dojFrom || dojTo) {
                filters.push({
                    fldname: "doj",
                    datatype: "DATE",
                    from: dojFrom ? formatDateForAPI(dojFrom) : "01/01/1900",
                    to: dojTo ? formatDateForAPI(dojTo) : "31/12/2999"
                });
            }

            const deptSelect = document.getElementById("deptFilter");
            const selectedDepts = Array.from(deptSelect.selectedOptions).map(opt => opt.value);
            if (selectedDepts.length > 0) {
                filters.push({
                    fldname: "department",
                    datatype: "DROPDOWN",
                    value: selectedDepts
                });
            }
        }

        // Load Employees from API
        function loadEmployees() {
            collectFilters();

            const params = {
                adsNames: ["employee_master_ads"],
                refreshCache: refreshCache,
                sqlParams: {
                    userparam_state: document.getElementById("stateFilter")?.value || "Karnataka"
                },
                keyField: "username",
                keyValue: "ALL",
                props: {
                    ADS: true,
                    CachePermissions: true,
                    getallrecordscount: true,
                    pageno: currentPage,
                    pagesize: pageSize,
                    keyfield: "",
                    keyvalue: "",
                    sorting: sorting,
                    filters: filters
                }
            };

            try {
                GetDataFromAxList(
                    params,
                    function success(response) {
                        let parsed = JSON.parse(response);
                        let employees = parsed.result.data[0].data || [];
                        renderTable(employees);
                        refreshCache = false;
                    },
                    function error(err) {
                        console.error("API error", err);
                    }
                );
            } catch (ex) {
                console.error("Exception while calling API", ex);
            }
        }

        // Render table rows
        function renderTable(employees) {
            const tbody = document.querySelector("#employeeTable tbody");
            tbody.innerHTML = "";

            employees.forEach(emp => {
                let row = `
              <tr>
                <td>${emp.employee_code}</td>
                <td>${emp.first_name} ${emp.last_name}</td>
                <td>${emp.gender}</td>
                <td>${formatDate(emp.doj)}</td>
                <td>${emp.department}</td>
                <td>${emp.designation}</td>
                <td>${emp.salary}</td>
                <td>${emp.status}</td>
                <td>${emp.state}</td>
              </tr>`;
                tbody.innerHTML += row;
            });
        }

        // Format date utility
        function formatDate(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            return d.toISOString().split("T")[0];
        }

        // Sorting setup
        function setupSorting() {
            document.querySelectorAll("#employeeTable thead th.sortable").forEach(th => {
                th.addEventListener("click", function () {
                    const field = this.getAttribute("data-field");
                    let current = sorting.find(s => s.fldname === field);

                    if (current) {
                        current.sort_order = current.sort_order === "asc" ? "desc" : "asc";
                    } else {
                        sorting = [{ fldname: field, sort_order: "asc" }];
                    }

                    document.querySelectorAll("#employeeTable thead th.sortable").forEach(th2 => {
                        th2.classList.remove("asc", "desc");
                    });
                    this.classList.add(current && current.sort_order === "desc" ? "desc" : "asc");

                    loadEmployees();
                });
            });
        }

        // Setup page events
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("refreshBtn").addEventListener("click", function () {
                refreshCache = true;
                loadEmployees();
            });

            document.getElementById("pageSelect").addEventListener("change", function () {
                currentPage = parseInt(this.value);
                loadEmployees();
            });

            document.getElementById("applyFilterBtn").addEventListener("click", function () {
                pageSize = 10;
                loadEmployees();
            });

            document.getElementById("clearFilterBtn").addEventListener("click", function () {
                filters = [];
                document.getElementById("empCodeFilter").value = "";
                document.getElementById("salaryFrom").value = "";
                document.getElementById("salaryTo").value = "";
                document.getElementById("dojFrom").value = "";
                document.getElementById("dojTo").value = "";
                document.getElementById("deptFilter").selectedIndex = -1;
                loadEmployees();
            });

            document.getElementById("loadAllRecordsBtn").addEventListener("click", function () {
                filters = [];
                pageSize = 0;
                document.getElementById("empCodeFilter").value = "";
                document.getElementById("salaryFrom").value = "";
                document.getElementById("salaryTo").value = "";
                document.getElementById("dojFrom").value = "";
                document.getElementById("dojTo").value = "";
                document.getElementById("deptFilter").selectedIndex = -1;
                loadEmployees();
            });

            setupSorting();
            loadEmployees();
        });
    </script>

</body>

</html>